<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khan Academy</title>
    <link rel="icon" type="image/png" href="https://cdn.kastatic.org/images/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --text-scale: 1;
        }

        :root[data-text-size="large"] {
            --text-scale: 1.2;
        }

        :root[data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --accent-color: #00ff88;
            --secondary-color: #888;
            --button-bg: rgba(0, 255, 136, 0.1);
            --button-hover: rgba(0, 255, 136, 0.2);
            --chat-bg: #2a2a2a;
            --ai-msg-bg: #333;
            --user-msg-bg: rgba(0, 255, 136, 0.1);
        }

        :root[data-theme="light"] {
            --bg-color: #f0f0f0;
            --text-color: #1a1a1a;
            --accent-color: #008844;
            --secondary-color: #555;
            --button-bg: rgba(0, 136, 68, 0.1);
            --button-hover: rgba(0, 136, 68, 0.2);
            --chat-bg: #ffffff;
            --ai-msg-bg: #f5f5f5;
            --user-msg-bg: rgba(0, 136, 68, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: calc(1rem * var(--text-scale));
        }

        .chat-container {
            flex: 1;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background: var(--chat-bg);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 4rem);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            padding: 1rem;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .ai-message {
            background: var(--ai-msg-bg);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background: var(--user-msg-bg);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: var(--chat-bg);
            border-top: 2px solid var(--accent-color);
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--accent-color);
            border-radius: 25px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: calc(1rem * var(--text-scale));
            resize: none;
            min-height: 60px;
            max-height: 150px;
            overflow-y: auto;
        }

        .chat-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .send-button {
            padding: 1rem 2rem;
            background: var(--button-bg);
            border: 2px solid var(--accent-color);
            border-radius: 25px;
            color: var(--accent-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: calc(1rem * var(--text-scale));
        }

        .send-button:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
        }

        .back-button {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            padding: 1rem 2rem;
            background: var(--button-bg);
            border: 2px solid var(--accent-color);
            border-radius: 25px;
            color: var(--accent-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: calc(1rem * var(--text-scale));
        }

        .back-button:hover {
            background: var(--button-hover);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 0;
                height: 100vh;
                border-radius: 0;
            }

            .back-button {
                bottom: 1rem;
                left: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="message ai-message">
                Hello! I'm your AI assistant. I can help you with:
                • Writing essays and papers
                • Answering questions
                • Explaining concepts
                • Solving problems
                • And much more!
                
                What would you like help with?
            </div>
        </div>
        <div class="input-container">
            <textarea class="chat-input" id="userInput" placeholder="Type your message here..." rows="1"></textarea>
            <button class="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <a href="index.html" class="back-button">← Back to Menu</a>

    <script>
        // Initialize settings from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            // Theme initialization
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // Text size initialization
            const largeText = localStorage.getItem('largeText') === 'true';
            document.documentElement.setAttribute('data-text-size', largeText ? 'large' : 'normal');

            // Setup textarea auto-resize
            const textarea = document.getElementById('userInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Setup enter key to send
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // Store conversation history
        let conversationHistory = [{
            role: "system",
            content: "You are an AI essay writer. When asked to write an essay, immediately generate a complete essay without showing the planning process. Make essays sound natural and include citations. If asked for other help, provide direct answers without showing your work. Keep responses concise and focused."
        }, {
            role: "assistant",
            content: "Hi! I'm your AI essay writer. Just tell me your essay topic or what you need help with, and I'll generate it right away. For essays, include:\n• The topic\n• Required length (if any)\n• Any specific requirements\n\nWhat would you like me to write?"
        }];

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, 'user-message');
                conversationHistory.push({
                    role: "user",
                    content: message
                });
                
                input.value = '';
                input.style.height = 'auto';
                
                // Show typing indicator
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai-message';
                typingDiv.textContent = 'Writing...';
                document.getElementById('chatMessages').appendChild(typingDiv);
                
                try {
                    // Make API request to Groq
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer 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'
                        },
                        body: JSON.stringify({
                            model: "meta-llama/llama-4-scout-17b-16e-instruct",
                            messages: conversationHistory,
                            max_tokens: 2000,
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();
                    
                    // Add error logging
                    if (!response.ok) {
                        console.error('API Error:', data);
                        throw new Error(data.error?.message || 'API request failed');
                    }
                    
                    // Remove typing indicator
                    typingDiv.remove();
                    
                    if (data.choices && data.choices[0]) {
                        const aiResponse = data.choices[0].message.content;
                        addMessage(aiResponse, 'ai-message');
                        conversationHistory.push({
                            role: "assistant",
                            content: aiResponse
                        });
                    } else {
                        console.error('Invalid API response structure:', data);
                        throw new Error('Invalid API response structure');
                    }
                } catch (error) {
                    // Remove typing indicator
                    typingDiv.remove();
                    
                    // Log the error for debugging
                    console.error('Error in sendMessage:', error);
                    
                    // Show error in chat
                    const errorMessage = `There was an error connecting to the AI service: ${error.message}. Please try again in a few moments.`;
                    addMessage(errorMessage, 'ai-message');
                    conversationHistory.push({
                        role: "assistant",
                        content: errorMessage
                    });
                }
            }
        }

        function addMessage(text, className) {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            
            // Convert line breaks to <br> tags and preserve formatting
            const formattedText = text.replace(/\n/g, '<br>');
            messageDiv.innerHTML = formattedText;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function generateFallbackResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            return `I'm having trouble connecting to the AI service right now. This could be because:

1. The API key might have expired
2. There might be a temporary connection issue
3. The Groq service might be experiencing high load

Please try again in a few moments. If the problem persists, let me know.`;
        }
    </script>
</body>
</html> 